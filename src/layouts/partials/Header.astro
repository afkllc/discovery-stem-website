---
import Logo from "@/components/Logo.astro";
import menu from "@/config/menu.json";
import config from "@/config/config.json";
import ThemeSwitcher from "@/components/ThemeSwitcher.astro";

const { navigation_button, settings } = config;

// determine if a menu item is active
const isMenuItemActive = (url: string) => {
  const pathname = Astro.url.pathname;
  if (url === "/") {
    return pathname === url ? "active" : "";
  }
  return pathname.startsWith(url) ? "active" : "";
};

// determine if any child is active
const isParentActive = (children: any[]) => {
  return children.some((child) => isMenuItemActive(child.url));
};
---

<header
  class:list={[
    "header z-30 sticky top-0",     // keep sticky & stacking context
    settings.sticky_header && "sticky top-0",
    "transform transition-transform duration-300 ease-in-out motion-reduce:transition-none",
    "will-change-transform",        // optional readable hint; if your Tailwind doesn't include it, it's harmless
  ]}
>
  <nav class="navbar flex-wrap container">
    <div
      class="order-1 flex items-center justify-between space-x-7 lg:space-x-14"
    >
      <Logo />

      <div class="hidden lg:flex items-center space-x-8">
        <ul class="flex items-center space-x-6">
          {
            menu.main.map((menuItem) => (
              menuItem.hasChildren && Array.isArray(menuItem.children) ? (
                <li class="relative group">
                  <button
                    class:list={[
                      "nav-link flex items-center py-2 px-3",
                      isParentActive(menuItem.children) && "text-secondary font-medium",
                    ]}
                    aria-haspopup="true"
                  >
                    {menuItem.name}
                  </button>

                  <ul class="absolute left-0 mt-2 hidden group-hover:block bg-white dark:bg-dark rounded-md shadow py-2 min-w-[160px] z-20">
                    {menuItem.children.map((child: { name: string; url: string }) => (
                      <li>
                        <a
                          href={child.url}
                          class="block py-2 px-4 hover:bg-gray-50 dark:hover:bg-darkmode-body"
                        >
                          {child.name}
                        </a>
                      </li>
                    ))}
                  </ul>
                </li>
              ) : (
                <li>
                  <a
                    href={menuItem.url}
                    class:list={["nav-link block py-2 px-3 rounded-lg transition-colors", isMenuItemActive(menuItem.url) && "text-secondary font-medium"]}
                  >
                    {menuItem.name}
                  </a>
                </li>
              )
            ))
          }

          <!-- {
            navigation_button.enable && (
              <li class="ml-2">
                <a
                  class="btn btn-outline-primary btn-sm"
                  href={navigation_button.link}
                >
                  {navigation_button.label}
                </a>
              </li>
            )
          } -->
        </ul>
      </div>
    </div>



    <div class="order-2 lg:order-3 ml-auto flex items-center lg:ml-0">
      <ThemeSwitcher className="mr-4 md:mr-6" />



      <div class="relative z-40 block md:hidden ml-6">
        {/* Mobile menu toggle button */}
        <label
          for="nav-toggle-mobile"
          class="cursor-pointer flex items-center text-text-dark dark:text-white border border-border dark:border-border/40 p-1 rounded-md"
        >
          <button id="nav-toggle-mobile" class="focus:outline-none">
            <svg class="h-5 fill-current block menu-open" viewBox="0 0 20 20">
              <title>Menu Open</title>
              <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
            </svg>
            <svg class="h-5 fill-current hidden menu-close" viewBox="0 0 20 20">
              <title>Menu Close</title>
              <polygon
                points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
                transform="rotate(45 10 10)"></polygon>
            </svg>
          </button>
        </label>

        {/* Mobile menu sidebar */}
        <div
          class="fixed top-0 left-0 h-full bg-black opacity-50 w-full hidden overlay"
        >
        </div>
        <div
          class="fixed top-0 left-0 h-full bg-white dark:bg-darkmode-body overflow-y-auto w-full md:w-96 p-9 sidebar-mobile transform -translate-x-full transition-transform"
        >
          {/* Same navigation list as desktop but for mobile */}
          <div class="flex justify-between items-center mb-14">
            <Logo />
            <button class="close-sidebar-mobile p-2">
              <svg class="h-5 fill-current block" viewBox="0 0 20 20">
                <title>Menu Close</title>
                <polygon
                  points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
                  transform="rotate(45 10 10)"></polygon>
              </svg>
            </button>
          </div>
          <ul class="nav-list">
            {
              menu.main.map((menuItem) => (
                <li
                  class:list={[
                    "nav-item",
                    menuItem.hasChildren && "has-children",
                  ]}
                >
                  {menuItem.hasChildren ? (
                    <>
                      <button
                        class:list={[
                          "nav-link w-full flex justify-between items-center",
                          "py-2 px-3 rounded-lg transition-colors",
                          isParentActive(menuItem.children) &&
                            "text-secondary font-medium",
                        ]}
                        data-submenu-toggle
                      >
                        {menuItem.name}
                        <svg
                          class="h-4 w-4 submenu-arrow transition-transform"
                          viewBox="0 0 24 24"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M6 9L12 15L18 9"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                      </button>
                      <ul class="submenu hidden pl-4 mt-2 space-y-2 bg-white dark:bg-dark rounded-md shadow py-4">
                        {menuItem.children.map((child) => (
                          <li>
                            <a
                              href={child.url}
                              class:list={[
                                "nav-dropdown-link block",
                                "py-2 px-3 rounded-lg transition-colors",
                                isMenuItemActive(child.url) &&
                                  "text-secondary font-medium",
                              ]}
                            >
                              {child.name}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </>
                  ) : (
                    <a
                      href={menuItem.url}
                      class:list={[
                        "nav-link block",
                        "py-2 px-3rounded-lg transition-colors",
                        isMenuItemActive(menuItem.url) &&
                          "text-secondary font-medium",
                      ]}
                    >
                      {menuItem.name}
                    </a>
                  )}
                </li>
              ))
            }
          </ul>
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  function initializeHeader() {
    const header = document.querySelector("header");
    const navToggleMobile = document.querySelector("#nav-toggle-mobile");
    const sidebarMobile = document.querySelector(".sidebar-mobile");
    const overlay = document.querySelector(".overlay");
    const closeButtonMobile = document.querySelector(".close-sidebar-mobile");
    const menuOpenIcons = document.querySelectorAll(".menu-open");
    const menuCloseIcons = document.querySelectorAll(".menu-close");
    const submenuToggles = document.querySelectorAll("[data-submenu-toggle]");

    let showSidebar = false;

    function toggleSidebar() {
      showSidebar = !showSidebar;
      if (showSidebar) {
        sidebarMobile?.classList.remove("-translate-x-full");
        overlay?.classList.remove("hidden");
        menuOpenIcons.forEach((icon) => icon.classList.add("hidden"));
        menuCloseIcons.forEach((icon) => icon.classList.remove("hidden"));
      } else {
        sidebarMobile?.classList.add("-translate-x-full");
        overlay?.classList.add("hidden");
        menuOpenIcons.forEach((icon) => icon.classList.remove("hidden"));
        menuCloseIcons.forEach((icon) => icon.classList.add("hidden"));
      }
    }

    function toggleSubmenu(e: { currentTarget: any; }) {
      const button = e.currentTarget;
      const submenu = button.nextElementSibling;
      const arrow = button.querySelector(".submenu-arrow");
      submenu?.classList.toggle("hidden");
      arrow?.classList.toggle("active");
    }

    // Hide-on-scroll (tailwind class toggling)
    let lastScrollY = window.scrollY || 0;
    let ticking = false;
    const scrollThreshold = 8; // px

    const prefersReducedMotion = window.matchMedia &&
      window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    function updateOnScroll() {
      ticking = false;
      const currentY = window.scrollY || 0;
      const delta = currentY - lastScrollY;

      // sidebarOpen = true if sidebar is visible (it loses -translate-x-full when open)
      const sidebarOpen = sidebarMobile && !sidebarMobile.classList.contains("-translate-x-full");

      // Always show at top
      if (currentY <= 0) {
        header?.classList.remove("-translate-y-full");
      } else if (!prefersReducedMotion && !sidebarOpen && Math.abs(delta) > scrollThreshold) {
        if (delta > 0 && currentY > (header?.offsetHeight || 64)) {
          // scrolling down: hide header
          header?.classList.add("-translate-y-full");
        } else if (delta < 0) {
          // scrolling up: show header
          header?.classList.remove("-translate-y-full");
        }
      }

      // Keep your shadow logic
      if (currentY > 0) {
        header?.classList.add("shadow-sm");
      } else {
        header?.classList.remove("shadow-sm");
      }

      lastScrollY = currentY;
    }

    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(updateOnScroll);
        ticking = true;
      }
    }

    // Listeners
    window.addEventListener("scroll", onScroll, { passive: true });
    navToggleMobile?.addEventListener("click", toggleSidebar);
    overlay?.addEventListener("click", toggleSidebar);
    closeButtonMobile?.addEventListener("click", toggleSidebar);
    submenuToggles.forEach((t) => t.addEventListener("click", toggleSubmenu));

    // initial state
    updateOnScroll();

    // return cleanup (if needed for hot reload)
    return () => {
      window.removeEventListener("scroll", onScroll);
      navToggleMobile?.removeEventListener("click", toggleSidebar);
      overlay?.removeEventListener("click", toggleSidebar);
      closeButtonMobile?.removeEventListener("click", toggleSidebar);
      submenuToggles.forEach((t) => t.removeEventListener("click", toggleSubmenu));
    };
  }

  document.addEventListener("astro:page-load", initializeHeader);
</script>
